name: 02 - Import single fork (interactive select)

on:
  workflow_dispatch:
    inputs:
      repo_full:
        description: 'Select a fork (owner/repo) to import from forks.json'
        required: true
        type: choice
        options:
          - "OurITRes/Git-Auto-Deploy"
          - "OurITRes/Tier0-User-Management"
          - "OurITRes/AD-Security-PingCastle"
          - "OurITRes/Modern_ActiveDirectory"
          - "OurITRes/ADTimeline"
          - "OurITRes/zjorz-Public-AD-Scripts"
          - "OurITRes/securedworkstation"
          - "OurITRes/DSInternals"
          - "OurITRes/Automated-Infra-PowerShell"
          - "OurITRes/SysAdmin-Tools"
          - "OurITRes/docs-guide"
          - "OurITRes/AD-Objects-ADACLScanner"
          - "OurITRes/AD-Security-ADControlPaths"
          - "OurITRes/JEA"
          - "OurITRes/ActiveDirectoryTools"
          - "OurITRes/CredentialManager"
          - "OurITRes/HostUtilities"
          - "OurITRes/BAMCIS.TokenManipulation"
          - "OurITRes/BAMCIS.Logging"
          - "OurITRes/Win32ScheduledTask"
          - "OurITRes/Hyper-VAdministration"
          - "OurITRes/DnsStig"
          - "OurITRes/ESAE"
          - "OurITRes/AssetInventory"
          - "OurITRes/ActiveDirectoryStig"
          - "IamPhilG/Star-Citizen_X56_natural"
          - "IamPhilG/freeCodeGram"
      run_mode:
        description: 'dry-run or real (real creates branch + PR)'
        required: true
        default: 'dry-run'
      migrate_path:
        description: 'Optional: override destination path inside monorepo'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  import_single:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq rsync git curl
          python -m pip install --upgrade pip
          pip install PyYAML PyJWT cryptography requests

      - name: Clean logs directory
        run: |
          mkdir -p logs
          rm -rf logs/* || true

      - name: Generate GitHub App JWT
        id: gen_jwt
        env:
          APP_ID: ${{ secrets.APP_ID }}
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          python3 scripts/app_jwt.py > jwt.txt
          JWT=$(cat jwt.txt)
          echo "jwt=$JWT" >> $GITHUB_OUTPUT

      - name: Get GitHub App installation id for OurITRes
        id: get_installation
        env:
          JWT: ${{ steps.gen_jwt.outputs.jwt }}
        run: |
          set -euo pipefail
          curl -s -H "Authorization: Bearer ${JWT}" -H "Accept: application/vnd.github+json" "https://api.github.com/app/installations" > installations.json
          INST_ID=$(python3 scripts/get_installation_id.py ouritres < installations.json)
          if [ -z "$INST_ID" ]; then
            echo "installation_id=" >> $GITHUB_OUTPUT
            echo "installation_response=$(jq -c . installations.json)" >> $GITHUB_OUTPUT
            echo "No installation for ouritres found" >&2
            exit 1
          fi
          echo "installation_id=$INST_ID" >> $GITHUB_OUTPUT

      - name: Create installation access token
        id: create_token
        env:
          JWT: ${{ steps.gen_jwt.outputs.jwt }}
          INSTALLATION_ID: ${{ steps.get_installation.outputs.installation_id }}
        run: |
          set -euo pipefail
          curl -s -X POST -H "Authorization: Bearer ${JWT}" -H "Accept: application/vnd.github+json" "https://api.github.com/app/installations/${INSTALLATION_ID}/access_tokens" > inst_token.json
          token=$(jq -r .token inst_token.json)
          if [ -z "$token" ] || [ "$token" = "null" ]; then
            echo "Failed to create installation token: $(cat inst_token.json)" >&2
            exit 1
          fi
          echo "installation_token=$token" >> $GITHUB_OUTPUT

      - name: Run import for single repo (uses installation token)
        env:
          INSTALLATION_TOKEN: ${{ steps.create_token.outputs.installation_token }}
          REPO_FULL: ${{ github.event.inputs.repo_full }}
          RUN_MODE: ${{ github.event.inputs.run_mode }}
          MIGRATE_PATH: ${{ github.event.inputs.migrate_path }}
        run: |
          set -euo pipefail
          mkdir -p logs
          if [ -n "${INSTALLATION_TOKEN:-}" ]; then
            export FORKS_MANAGER_PAT="${INSTALLATION_TOKEN}"
          fi
          chmod +x scripts/import_one_repo.sh
          ./scripts/import_one_repo.sh "${REPO_FULL}" "${RUN_MODE}" "${MIGRATE_PATH:-}" 2>&1 | tee "logs/import-${REPO_FULL//\//_}-${RUN_MODE}.log"

      - name: Upload logs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: import-single-logs
          path: logs/