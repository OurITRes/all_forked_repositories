name: 04 - Cleanup original repo (delete old)

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: 'Repository name to delete under OurITRes (e.g. Git-Auto-Deploy).'
        required: true
      confirm:
        description: 'Type CONFIRM to perform deletion.'
        required: true

# Note: actual deletion is performed via the GitHub App installation token (preferred).
permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Setup tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          python -m pip install --upgrade pip
          pip install PyJWT cryptography

      - name: Ensure logs dir
        run: |
          mkdir -p logs
          rm -f logs/cleanup-*.log

      - name: Generate GitHub App JWT
        id: gen_jwt
        env:
          APP_ID: ${{ secrets.APP_ID }}
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${APP_ID:-}" ] || [ -z "${APP_PRIVATE_KEY:-}" ]; then
            echo "APP_ID or APP_PRIVATE_KEY secret not set" >&2
            exit 1
          fi
          python3 scripts/app_jwt.py > jwt.txt
          JWT=$(cat jwt.txt)
          echo "jwt=$JWT" >> $GITHUB_OUTPUT

      - name: Get installation id for OurITRes
        id: get_installation
        env:
          JWT: ${{ steps.gen_jwt.outputs.jwt }}
        run: |
          set -euo pipefail
          if [ -z "${JWT:-}" ]; then
            echo "No JWT available" >&2
            exit 1
          fi
          curl -s -H "Authorization: Bearer ${JWT}" -H "Accept: application/vnd.github+json" "https://api.github.com/app/installations" > installations.json
          INST_ID=$(python3 scripts/get_installation_id.py ouritres < installations.json)
          if [ -z "$INST_ID" ]; then
            echo "installation_id=" >> $GITHUB_OUTPUT
            echo "installation_response=$(jq -c . installations.json)" >> $GITHUB_OUTPUT
            echo "No installation id for ouritres found" >&2
            exit 1
          fi
          echo "installation_id=$INST_ID" >> $GITHUB_OUTPUT

      - name: Create installation access token
        id: create_token
        env:
          JWT: ${{ steps.gen_jwt.outputs.jwt }}
          INSTALLATION_ID: ${{ steps.get_installation.outputs.installation_id }}
        run: |
          set -euo pipefail
          if [ -z "${JWT:-}" ] || [ -z "${INSTALLATION_ID:-}" ]; then
            echo "Missing JWT or INSTALLATION_ID" >&2
            exit 1
          fi
          curl -s -X POST -H "Authorization: Bearer ${JWT}" -H "Accept: application/vnd.github+json" "https://api.github.com/app/installations/${INSTALLATION_ID}/access_tokens" > inst_token.json
          token=$(jq -r .token inst_token.json)
          expires_at=$(jq -r .expires_at inst_token.json)
          if [ -z "$token" ] || [ "$token" = "null" ]; then
            echo "Failed to create installation token: $(cat inst_token.json)" >&2
            exit 1
          fi
          echo "installation_token=$token" >> $GITHUB_OUTPUT
          echo "installation_token_expires=${expires_at}" >> $GITHUB_OUTPUT

      - name: Confirm & delete repository (uses GitHub App installation token)
        env:
          INSTALLATION_TOKEN: ${{ steps.create_token.outputs.installation_token }}
          GITHUB_TOKEN: ${{ github.token }}
          REPO_NAME: ${{ github.event.inputs.repo_name }}
          CONFIRM: ${{ github.event.inputs.confirm }}
        run: |
          set -euo pipefail
          LOGFILE="logs/cleanup-${REPO_NAME}-$(date -u +%Y%m%d-%H%M%S).log"
          echo "Cleanup run for OurITRes/${REPO_NAME}" | tee -a "$LOGFILE"

          if [ "$CONFIRM" != "CONFIRM" ]; then
            echo "Confirmation not provided. Abort." | tee -a "$LOGFILE"
            exit 1
          fi

          # Use installation token (GitHub App) if available; otherwise fallback to GITHUB_TOKEN.
          if [ -n "${INSTALLATION_TOKEN:-}" ]; then
            TOKEN="${INSTALLATION_TOKEN}"
            echo "Using INSTALLATION_TOKEN (GitHub App) for deletion" | tee -a "$LOGFILE"
          else
            TOKEN="${GITHUB_TOKEN:-}"
            echo "No installation token found; falling back to GITHUB_TOKEN (may lack admin permissions)" | tee -a "$LOGFILE"
          fi

          if [ -z "${TOKEN:-}" ]; then
            echo "No token available. Aborting." | tee -a "$LOGFILE"
            exit 1
          fi

          echo "Calling GitHub API to delete OurITRes/${REPO_NAME} ..." | tee -a "$LOGFILE"
          HTTP_STATUS=$(curl -s -o /tmp/delete_response -w "%{http_code}" -X DELETE -H "Authorization: token ${TOKEN}" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/OurITRes/${REPO_NAME}")
          echo "HTTP status: ${HTTP_STATUS}" | tee -a "$LOGFILE"
          cat /tmp/delete_response | tee -a "$LOGFILE" || true

          if [ "${HTTP_STATUS}" -eq 204 ]; then
            echo "Repository deleted successfully." | tee -a "$LOGFILE"
          else
            echo "Deletion may have failed (status ${HTTP_STATUS}). Check response above and token permissions." | tee -a "$LOGFILE"
            exit 1
          fi

      - name: Upload logs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-logs
          path: logs/