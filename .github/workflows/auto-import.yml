name: Auto import forks (dry-run by default)

on:
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'run mode: "dry-run" => simulate; "real" => perform import (will create PRs). Choose "real" only when ready.'
        required: true
        default: 'dry-run'
  schedule:
    - cron: '0 4 * * *' # daily at 04:00 UTC (adjust as needed)

permissions:
  contents: write   # required to push branches / create commits
  pull-requests: write

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq rsync git curl

      - name: Install Python deps
        run: python -m pip install --upgrade pip && pip install -r requirements.txt

      - name: Prepare and run import
        env:
          FORKS_MANAGER_PAT: ${{ secrets.FORKS_MANAGER_PAT }}
        run: |
          chmod +x scripts/squash_import_to_monorepo.sh
          # Default: dry-run
          if [ "${{ github.event.inputs.run_mode || 'dry-run' }}" = "real" ]; then
            echo "Running REAL import: will create PRs (--pr). Make sure FORKS_MANAGER_PAT has 'repo' scope and permission to push/create branches."
            ./scripts/squash_import_to_monorepo.sh forks.yaml --pr
          else
            echo "Running DRY-RUN (no push / PR / delete)."
            ./scripts/squash_import_to_monorepo.sh forks.yaml --dry-run
          fi
          
      - name: Upload logs (artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: import-logs
          path: logs/
          