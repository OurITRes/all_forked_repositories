name: Auto import forks (dry-run by default)

on:
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'run mode: "dry-run" => simulate; "real" => perform import (creates PRs). Choose "real" only when ready.'
        required: true
        default: 'dry-run'
  schedule:
    - cron: '0 4 * * *' # daily at 04:00 UTC (adjust as needed)

permissions:
  contents: write
  pull-requests: write

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install system tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq rsync git curl

      - name: Install Python deps
        run: python -m pip install --upgrade pip && pip install -r requirements.txt

      - name: Prepare and run import
        id: run_import
        env:
          # Do NOT rely on a long-lived classic PAT here inside Actions.
          # We intentionally prefer the runtime token (GITHUB_TOKEN) via github.token.
          # If you want to use a custom PAT, set the repo secret FORKS_MANAGER_PAT,
          # but note org policies may reject long-lived classic tokens.
          FORKS_MANAGER_PAT: ${{ secrets.FORKS_MANAGER_PAT }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          set -o pipefail
          chmod +x scripts/squash_import_to_monorepo.sh
          if [ "${{ github.event.inputs.run_mode || 'dry-run' }}" = "real" ]; then
            echo "Running REAL import: will create PRs (--pr)."
            ./scripts/squash_import_to_monorepo.sh forks.yaml --pr 2>&1 | tee logs/run-output-${{ github.run_id }}.log
          else
            echo "Running DRY-RUN (no push / PR / delete)."
            ./scripts/squash_import_to_monorepo.sh forks.yaml --dry-run 2>&1 | tee logs/run-output-${{ github.run_id }}.log
          fi

      - name: Scan logs for ERRORs / push failures
        if: always()
        run: |
          set -e
          # Look for common failure markers in logs produced by the script
          echo "Scanning logs for errors..."
          mkdir -p scan_out
          grep -R --line-number --color=never -E "ERROR:|fatal:|remote: The 'OurITRes' organization forbids access|Permission to ${REPO_CENTRAL_OWNER}/${REPO_CENTRAL_NAME}" logs/ || true
          # return non-zero if any error lines matched
          ERRCOUNT=$(grep -R -E "ERROR:|fatal:|remote: The 'OurITRes' organization forbids access|Permission to ${REPO_CENTRAL_OWNER}/${REPO_CENTRAL_NAME}" logs/ | wc -l || true)
          echo "Detected $ERRCOUNT matching error lines"
          if [ "$ERRCOUNT" -gt 0 ]; then
            echo "ERRORS found in logs; failing workflow so you can inspect artifacts."
            exit 1
          fi
          echo "No error markers found in logs."

      - name: Upload logs (artifacts)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: import-logs
          path: logs/
          