name: Auto import forks (dry-run by default)

on:
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'run mode (dry-run / real)'
        required: true
        default: 'dry-run'
  schedule:
    - cron: '0 4 * * *' # daily at 04:00 UTC (adjust as needed)

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout scripts
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install tools
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq rsync git curl

      - name: Install Python deps
        run: python -m pip install --upgrade pip &cd & pip install -r requirements.txt

      - name: Run import (dry-run by default)
        env:
          FORKS_MANAGER_PAT: ${{ secrets.FORKS_MANAGER_PAT }}
        run: |
          chmod +x scripts/squash_import_to_monorepo.sh
          if [ "${{ github.event.inputs.run_mode || 'dry-run' }}" = "real" ]; then
            echo "Running real import (no dry-run)."
            ./scripts/squash_import_to_monorepo.sh forks.yaml
          else
            echo "Running dry-run (no push / PR / delete)."
            ./scripts/squash_import_to_monorepo.sh forks.yaml --dry-run
          fi
