name: 03 - Sync folders from upstreams (scheduled/manual)

on:
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'dry-run or real (real will create PRs).'
        required: true
        default: 'dry-run'
  schedule:
    - cron: '0 3 * * *' # nightly

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup environment
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq git curl rsync
          python -m pip install --upgrade pip
          pip install PyYAML requests

      - name: Clean logs directory
        run: |
          mkdir -p logs
          rm -rf logs/* || true

      - name: Generate GitHub App JWT
        id: gen_jwt
        env:
          APP_ID: ${{ secrets.APP_ID }}
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          if [ -z "${APP_ID:-}" ] || [ -z "${APP_PRIVATE_KEY:-}" ]; then
            echo "APP_ID or APP_PRIVATE_KEY secret not set" >&2
            exit 1
          fi
          python3 scripts/app_jwt.py > jwt.txt
          JWT=$(cat jwt.txt)
          echo "jwt=$JWT" >> $GITHUB_OUTPUT

      - name: Get GitHub App installation id for OurITRes
        id: get_inst
        env:
          JWT: ${{ steps.gen_jwt.outputs.jwt }}
        run: |
          set -euo pipefail
          if [ -z "${JWT:-}" ]; then
            echo "No JWT available" >&2
            exit 1
          fi
          curl -s -H "Authorization: Bearer ${JWT}" -H "Accept: application/vnd.github+json" "https://api.github.com/app/installations" > installations.json
          INST_ID=$(python3 scripts/get_installation_id.py ouritres < installations.json)
          if [ -z "$INST_ID" ]; then
            echo "installation_id=" >> $GITHUB_OUTPUT
            echo "installation_response=$(jq -c . installations.json)" >> $GITHUB_OUTPUT
            echo "No installation for ouritres found" >&2
            exit 1
          fi
          echo "installation_id=$INST_ID" >> $GITHUB_OUTPUT

      - name: Create installation access token
        id: create_token
        env:
          JWT: ${{ steps.gen_jwt.outputs.jwt }}
          INSTALLATION_ID: ${{ steps.get_inst.outputs.installation_id }}
        run: |
          set -euo pipefail
          if [ -z "${JWT:-}" ] || [ -z "${INSTALLATION_ID:-}" ]; then
            echo "Missing JWT or INSTALLATION_ID" >&2
            exit 1
          fi
          curl -s -X POST -H "Authorization: Bearer ${JWT}" -H "Accept: application/vnd.github+json" "https://api.github.com/app/installations/${INSTALLATION_ID}/access_tokens" > inst_token.json
          token=$(jq -r .token inst_token.json)
          expires_at=$(jq -r .expires_at inst_token.json)
          if [ -z "$token" ] || [ "$token" = "null" ]; then
            echo "Failed to create installation token: $(cat inst_token.json)" >&2
            exit 1
          fi
          echo "installation_token=$token" >> $GITHUB_OUTPUT
          echo "installation_token_expires=${expires_at}" >> $GITHUB_OUTPUT

      - name: Run sync script
        env:
          INSTALLATION_TOKEN: ${{ steps.create_token.outputs.installation_token }}
          GITHUB_TOKEN: ${{ github.token }}
          RUN_MODE: ${{ github.event.inputs.run_mode || 'dry-run' }}
        run: |
          set -euo pipefail
          mkdir -p logs
          # prefer installation token (GitHub App) when available
          if [ -n "${INSTALLATION_TOKEN:-}" ]; then
            echo "Using GitHub App installation token"
            export FORKS_MANAGER_PAT="${INSTALLATION_TOKEN}"
          else
            echo "No installation token found, falling back to GITHUB_TOKEN"
            export FORKS_MANAGER_PAT="${GITHUB_TOKEN}"
          fi
          chmod +x scripts/sync_forks.py
          python3 scripts/sync_forks.py "$RUN_MODE" 2>&1 | tee logs/sync-run-${{ github.run_id }}.log

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs
          path: logs/